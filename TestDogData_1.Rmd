---
title: "Eval Landsharc sims"
author: "Katie Lotterhos"
date: "May 24, 2016"
output: html_document
---

### Load packages and data
```{r setup, include=FALSE}
#setwd("/Users/katie/Desktop/MINOTAUReval")
source("evalsims/ComparePlot2.R")
source("evalsims/distanceFunctionsOther.R")
source("evalsims/getEmpiricalP3_BH.R")
source("evalsims/Getdf.R")


if(!("devtools" %in% installed.packages())){install.packages("devtools", dependencies=TRUE)}
if(!("rrcovNA" %in% installed.packages())){install.packages("rrcovNA")}

library(qvalue)
library(rrcovNA)
library(devtools)
install_github("NESCent/MINOTAUR")#, build_vignettes=TRUE)
library(MINOTAUR)

headdir <- "~/Desktop/MINOTAUReval/data/dog_full/"
outdir <- "~/Desktop/MINOTAUReval/data/dog_full_multvar_iHS_pi_TD_H12/"
#resultsdir <- "~/Desktop/MINOTAUReval/results/"
filelist <- list.files(headdir)
length(filelist)
if (!length(filelist)==25){print("Errr: missing simulation files")}

sessionInfo()
```

### Loop through each dataset
The following chunk of code does for each dataset:
1) calculate multivariate distances based on default covariance matrix
2) compares covariance matrix estimated from just neutral loci to covariance matrix on all data and MCD estimate of covariance
3) calculate multivariate distances based on MCD covariance matrix


```{r loop1}
cov_summary <- data.frame(filelist, Sall_Smcd0.75_cov=NA, Sall_Smcd0.75_mean=NA,
                          Sall_Smcd0.99_cov=NA, Sall_Smcd0.99_mean=NA)
head(cov_summary)
for (i in 1:length(filelist)){
   print(c(i, filelist[i]))
  infile <- paste(headdir, filelist[i], sep="")
  dat <- read.csv(infile, header=TRUE)
  head(dat)
   dat2 <- dat[complete.cases(dat),]# #don't use complete cases if want to keep all data
  cols <- which(names(dat) %in% c("unstd_iHS", 
                                  "win51_pi",
                                  "win51_TajD",
                                  "win51_H12"))
  # Covariance of all loci
    Sall <- cov(dat2[complete.cases(dat2),cols])
    Sall
  # Covariance of MCD 75
    S_mcd75 <- CovNAMcd(dat2[,cols], alpha=0.75)
    #S_mcd75
  # Covariance of MCD 99
    S_mcd99 <- CovNAMcd(dat2[,cols], alpha=0.99)
    #S_mcd99    
    
  ## Mean difference between covmats
    Sall_mean <- colMeans(dat2[complete.cases(dat2),cols])
    
    cov_summary$Sall_Smcd0.75_cov[i] <- mean(abs(Sall-S_mcd75@cov))
    cov_summary$Sall_Smcd0.75_mean[i] <- mean(abs( Sall_mean-S_mcd75@center))
    cov_summary$Sall_Smcd0.99_cov[i] <- mean(abs(Sall-S_mcd99@cov)) 
    cov_summary$Sall_Smcd0.99_mean[i] <- mean(abs(Sall_mean-S_mcd99@center))
    print(cov_summary[i,])
}
   write.csv(cov_summary, file = paste(outdir,"covsummary.csv", sep=""))
``` 

```{r loop2}    
for (i in 4:length(filelist)){
  print(c(i, filelist[i]))
  infile <- paste(headdir, filelist[i], sep="")
  dat <- read.csv(infile, header=TRUE)
  #head(dat)
  cols <- which(names(dat) %in% c("unstd_iHS", 
                                  "win51_pi",
                                  "win51_TajD",
                                  "win51_H12"))
    # don't include H: makes cov matrix singular
  cols
  dat2 <- dat[complete.cases(dat),]# #don't use complete cases if want to keep all data
  
 # Covariance of MCD 75
    S_mcd75 <- CovNAMcd(dat2[,cols], alpha=0.75)
    #S_mcd75
  # Covariance of MCD 99
    S_mcd99 <- CovNAMcd(dat2[,cols], alpha=0.99)
    #S_mcd99    
    
  ### Get stats based on covmat of all the data
  dat.out.defaultS <- Getdf(dat2, cols)
  head(dat.out.defaultS)
  colnames(dat.out.defaultS)[(ncol(dat.out.defaultS)-5):
                               ncol(dat.out.defaultS)] <-
    c("pcs.default","Hcd.default", "Md.default", 
      "Hd.default", "Kd.default", "Nd.default")
  #head(dat.out.defaultS)
  #dim(dat.out)
    
  ### Get stats based on mcd covmat and robust points for alpha = 0.75
    dat.out.subset <- Getdf(dat.out.defaultS, cols, S=S_mcd75@cov,  M=S_mcd75@center, subset=which(S_mcd75@raw.wt==1), whichstats=c("md", "hd", "kd", "nd"))
    #head(dat.out.subset)
    colnames(dat.out.subset)[(ncol(dat.out.subset)-3):
                               ncol(dat.out.subset)] <-
    c("Md.mcd.subset.75", "Hd.mcd.subset.75", "Kd.mcd.subset.75", "Nd.mcd.subset.75") 
     dat.out.subset$robust75 <- S_mcd75@raw.wt==1
    #head(dat.out.subset)
  
  ### Get stats based on mcd covmat and robust points for alpha = 0.99   
    dat.out.subset2 <- Getdf(dat.out.subset, cols, S=S_mcd99@cov,  M=S_mcd99@center, subset=which(S_mcd75@raw.wt==1), whichstats=c("md", "hd", "kd", "nd"))
    #head(dat.out.subset)
    colnames(dat.out.subset2)[(ncol(dat.out.subset2)-3):
                               ncol(dat.out.subset2)] <-
    c("Md.mcd.subset.99", "Hd.mcd.subset.99", "Kd.mcd.subset.99", "Nd.mcd.subset.99") 
     dat.out.subset2$robust99 <- S_mcd99@raw.wt==1
     
      
    #plot(dat.out.subset$Md.mcd.subset)
    #plot(dat.out.subset$Hd.mcd.subset)
    #plot(log(dat.out.subset$Kd.mcd.subset))
    
    #plot(dat.out.subset$Nd.default)
    #plot(dat.out.subset$Nd.mcd.subset)
    #points(dat.out.subset$Nd.mcd.subset[S_mcd75@raw.wt==1], col="magenta", pch=19, cex=0.1)
      
  write.csv(dat.out.subset2, file = paste(outdir,"set1_", filelist[i], sep=""))
}

```
